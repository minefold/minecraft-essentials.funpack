#!/usr/bin/env ruby

# encoding: UTF-8

# usage: run <server-json>
# runs the server

require 'json'
require 'time'
require 'set'
require 'open3'

$:.unshift File.expand_path('../../lib', __FILE__)

require 'log_processor'

STDOUT.sync = true
STDIN.sync = true

server_json = ARGV.first
bin = File.expand_path File.join(__FILE__, '..')

server_settings = JSON.parse(File.read(server_json))
system "#{bin}/prepare #{server_json}"

ram_min, ram_max = server_settings['ram']['min'], server_settings['ram']['max']

# since we can't query bukkit player list without getting nicknames and weird
# stuff, cache the player connects and disconnects
player_cache = Set.new

Open3.popen3("java",
            "-Xms#{ram_min}M", "-Xmx#{ram_max}M",
            "-jar", "craftbukkit.jar",
            "nogui") do |stdin, stdout, stderr, wait_thr|

  processor = LogProcessor.new(wait_thr.pid, player_cache)

  begin
    # read stdin. On list command we respond directly
    # anything else pass through to minecraft
    Thread.new do
      while true
        input = STDIN.readline.strip
        case input
        when 'list'
          processor.event 'players_list', usernames: player_cache.to_a

        else
          stdin.puts input
        end
      end
    end

    while true
      processor.process_line stderr.readline
    end
  rescue EOFError
  end
  exit_status = wait_thr.value
end